var j="142.250.191.78",M="trojanPassword",D="https://cloudflare-dns.com/dns-query",U="2fb55e67-f61d-45a1-9619-a9cac3529382",_=["443","8443","2053","2083","2087","2096"],R=e=>{let n=e.headers.get("Host")||"",t=new URL(e.url),s=t.pathname,o=new URLSearchParams(t.search).get("app");return{hostName:n,pathName:s,client:o}};var H={remoteDNS:"https://8.8.8.8/dns-query",resolvedRemoteDNS:{},localDNS:"8.8.8.8",vlessTrojanFakeDNS:!1,proxyIP:"",outProxy:"",outProxyParams:{},cleanIPs:"",enableIPv6:!0,customCdnAddrs:"",customCdnHost:"",customCdnSni:"",bestVLESSTrojanInterval:"30",vlessConfigs:!0,trojanConfigs:!1,ports:["443"],lengthMin:"100",lengthMax:"200",intervalMin:"1",intervalMax:"1",fragmentPackets:"tlshello",bypassLAN:!1,bypassIran:!1,bypassChina:!1,bypassRussia:!1,blockAds:!1,blockPorn:!1,blockUDP443:!1,customBypassRules:"",customBlockRules:"",warpEndpoints:"engage.cloudflareclient.com:2408",warpFakeDNS:!1,warpEnableIPv6:!0,warpPlusLicense:"",bestWarpInterval:"30",hiddifyNoiseMode:"m4",nikaNGNoiseMode:"quic",noiseCountMin:"10",noiseCountMax:"15",noiseSizeMin:"5",noiseSizeMax:"10",noiseDelayMin:"1",noiseDelayMax:"1",panelVersion:"1"};async function O(e){let n=`${D}?name=${encodeURIComponent(e)}&type=A`,t=`${D}?name=${encodeURIComponent(e)}&type=AAAA`;try{let[s,r]=await Promise.all([fetch(n,{headers:{accept:"application/dns-json"}}),fetch(t,{headers:{accept:"application/dns-json"}})]),o=await s.json(),c=await r.json(),a=o.Answer?o.Answer.map(i=>i.data):[],l=c.Answer?c.Answer.map(i=>i.data):[];return{ipv4:a,ipv6:l}}catch(s){throw new Error(`An error occurred while resolving DNS - ${s}`)}}function B(e){return/^(?!\-)(?:[A-Za-z0-9\-]{1,63}\.)+[A-Za-z]{2,}$/.test(e)}function z(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}async function Y(e,n,t){let s=await O(e),r=t?s.ipv6.map(o=>`[${o}]`):[];return[e,"www.speedtest.net",...s.ipv4,...r,...n?n.split(","):[]]}function q(e){let n="";for(let t=0;t<e.length;t++)n+=Math.random()<.5?e[t].toUpperCase():e[t];return n}function W(e,n,t,s,r,o){let c,a=o?` ${o}`:"";return s.includes(t)?c="Clean IP":c=B(t)?"Domain":oe(t)?"IPv4":ae(t)?"IPv6":"",`\u{1F4A6} ${e} - ${r}${a} - ${c} : ${n}`}function oe(e){return/^(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(?:\/([0-9]|[1-2][0-9]|3[0-2]))?$/.test(e)}function ae(e){return/^\[(?:(?:[a-fA-F0-9]{1,4}:){7}[a-fA-F0-9]{1,4}|(?:[a-fA-F0-9]{1,4}:){1,7}:|::(?:[a-fA-F0-9]{1,4}:){0,7}|(?:[a-fA-F0-9]{1,4}:){1,6}:[a-fA-F0-9]{1,4}|(?:[a-fA-F0-9]{1,4}:){1,5}(?::[a-fA-F0-9]{1,4}){1,2}|(?:[a-fA-F0-9]{1,4}:){1,4}(?::[a-fA-F0-9]{1,4}){1,3}|(?:[a-fA-F0-9]{1,4}:){1,3}(?::[a-fA-F0-9]{1,4}){1,4}|(?:[a-fA-F0-9]{1,4}:){1,2}(?::[a-fA-F0-9]{1,4}){1,5}|[a-fA-F0-9]{1,4}:(?::[a-fA-F0-9]{1,4}){1,6})\](?:\/(1[0-1][0-9]|12[0-8]|[0-9]?[0-9]))?$/.test(e)}function G(e){let n="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=t.length;for(let r=0;r<e;r++)n+=t.charAt(Math.floor(Math.random()*s));return n}async function Z(e,n){let{hostName:t,client:s}=R(e),{cleanIPs:r,proxyIP:o,ports:c,vlessConfigs:a,trojanConfigs:l,outProxy:i,customCdnAddrs:p,customCdnHost:d,customCdnSni:h,enableIPv6:f}=H,m=await Y(t,r,f),I=p?p.split(","):[],A=[...m,...I],y=s==="singbox"?"http/1.1":"h2,http/1.1",u=encodeURIComponent(M),w=s==="singbox"?"&eh=Sec-WebSocket-Protocol&ed=2560":encodeURIComponent("?ed=2560"),g="",C="",x="",k=1;if(c.forEach(S=>{A.forEach((v,E)=>{let P=E>m.length-1,L=P?"C":"",ne=P?h:q(t),N=P?d:t,F=`${G(16)}${o?`/${encodeURIComponent(btoa(o))}`:""}${w}`,re=encodeURIComponent(W(k,S,v,r,"VLESS",L)),se=encodeURIComponent(W(k,S,v,r,"Trojan",L)),V=_.includes(S)?`&security=tls&sni=${ne}&fp=randomized&alpn=${y}`:"&security=none";a&&(g+=`${atob("dmxlc3M6Ly8=")}${U}@${v}:${S}?path=/vl${F}&encryption=none&host=${N}&type=ws${V}#${re}
`),l&&(C+=`${atob("dHJvamFuOi8v")}${u}@${v}:${S}?path=/tr${F}&host=${N}&type=ws${V}#${se}
`),k++})}),i){let S=`#${encodeURIComponent("\u{1F4A6} Chain proxy \u{1F517}")}`;if(i.startsWith("socks")||i.startsWith("http")){let v=/^(?:socks|http):\/\/([^@]+)@/,E=i.match(v),P=E?E[1]:!1;x=P?i.replace(P,btoa(P))+S:i+S}else x=i.split("#")[0]+S}let te=btoa(g+C+x);return new Response(te,{status:200,headers:{"Content-Type":"text/plain;charset=utf-8","Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate","CDN-Cache-Control":"no-store"}})}import{connect as ce}from"cloudflare:sockets";function b(e){try{(e.readyState===1||e.readyState===2)&&e.close()}catch{}}async function T(e,n,t,s){let r=t,o=!1;await e.readable.pipeTo(new WritableStream({start(){},async write(c,a){o=!0,n.readyState!==1&&a.error("webSocket.readyState is not open, maybe close"),r?(n.send(await new Blob([r,c]).arrayBuffer()),r=null):n.send(c)}})).catch(()=>{b(n)}),o===!1&&s&&s()}async function J(e,n,t,s,r,o,c){let{pathName:a}=R(e);async function l(d,h){/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(d)&&(d=`${atob("d3d3Lg==")}${d}${atob("LnNzbGlwLmlv")}`);let f=ce({hostname:d,port:h});n.value=f;let m=f.writable.getWriter();return await m.write(r),m.releaseLock(),f}async function i(){let d=a.split("/")[2],h=d?atob(d).split(","):void 0,f=h?h[Math.floor(Math.random()*h.length)]:j||t,m=await l(f,s);m.closed.catch(()=>{}).finally(()=>{b(o)}),T(m,o,c,null)}let p=await l(t,s);T(p,o,c,i)}async function Q(e,n){let t=!1,s=new TransformStream({start(o){},transform(o,c){for(let a=0;a<o.byteLength;){let l=o.slice(a,a+2),i=new DataView(l).getUint16(0),p=new Uint8Array(o.slice(a+2,a+2+i));a=a+2+i,c.enqueue(p)}},flush(o){}});s.readable.pipeTo(new WritableStream({async write(o){let a=await(await fetch(D,{method:"POST",headers:{"content-type":"application/dns-message"},body:o})).arrayBuffer(),l=a.byteLength,i=new Uint8Array([l>>8&255,l&255]);e.readyState===1&&(t?e.send(await new Blob([i,a]).arrayBuffer()):(e.send(await new Blob([n,i,a]).arrayBuffer()),t=!0))}})).catch(()=>{});let r=s.writable.getWriter();return{write(o){r.write(o)}}}async function K(e,n){if(e.byteLength<24)return{hasError:!0,message:"invalid data"};let t=new Uint8Array(e.slice(0,1)),s=!1,r=!1,o=new Uint8Array(e.slice(1,17)),c=de(o),a=n.includes(",")?n.split(","):[n],l=await le(c);if(s=a.some(g=>l||c===g.trim()),!s)return{hasError:!0,message:"invalid user"};let i=new Uint8Array(e.slice(17,18))[0],p=new Uint8Array(e.slice(18+i,18+i+1))[0];if(p!==1)if(p===2)r=!0;else return{hasError:!0,message:`command ${p} is not support, command 01-tcp,02-udp,03-mux`};let d=18+i+1,h=e.slice(d,d+2),f=new DataView(h).getUint16(0),m=d+2,A=new Uint8Array(e.slice(m,m+1))[0],y=0,u=m+1,w="";switch(A){case 1:y=4,w=new Uint8Array(e.slice(u,u+y)).join(".");break;case 2:y=new Uint8Array(e.slice(u,u+1))[0],u+=1,w=new TextDecoder().decode(e.slice(u,u+y));break;case 3:y=16;let g=new DataView(e.slice(u,u+y)),C=[];for(let x=0;x<8;x++)C.push(g.getUint16(x*2).toString(16));w=C.join(":");break;default:return{hasError:!0,message:`invild  addressType is ${A}`}}return w?{hasError:!1,addressRemote:w,addressType:A,portRemote:f,rawDataIndex:u+y,vlessVersion:t,isUDP:r}:{hasError:!0,message:`addressValue is empty, addressType is ${A}`}}async function le(e){return!1}function pe(e,n=0){let t=[];for(let s=0;s<256;++s)t.push((s+256).toString(16).slice(1));return(t[e[n+0]]+t[e[n+1]]+t[e[n+2]]+t[e[n+3]]+"-"+t[e[n+4]]+t[e[n+5]]+"-"+t[e[n+6]]+t[e[n+7]]+"-"+t[e[n+8]]+t[e[n+9]]+"-"+t[e[n+10]]+t[e[n+11]]+t[e[n+12]]+t[e[n+13]]+t[e[n+14]]+t[e[n+15]]).toLowerCase()}function de(e,n=0){let t=pe(e,n);if(!z(t))throw TypeError("Stringified UUID is invalid");return t}function X(e,n){let t=!1;return new ReadableStream({start(r){e.addEventListener("message",a=>{if(t)return;let l=a.data;r.enqueue(l)}),e.addEventListener("close",()=>{b(e),!t&&r.close()}),e.addEventListener("error",a=>{console.log("webSocketServer has error"),r.error(a)});let{earlyData:o,error:c}=base64ToArrayBuffer(n);c?r.error(c):o&&r.enqueue(o)},pull(r){},cancel(r){t||(console.log(`ReadableStream was canceled, due to ${r}`),t=!0,b(e))}})}async function ee(e,n){let t=new WebSocketPair,[s,r]=Object.values(t);r.accept();let o=e.headers.get("sec-websocket-protocol")||"",c=X(r,o),a={value:null},l=null,i=!1;return c.pipeTo(new WritableStream({async write(p){if(i&&l)return l(p);if(a.value){let g=a.value.writable.getWriter();await g.write(p),g.releaseLock();return}let{hasError:d,message:h,portRemote:f=443,addressRemote:m="",rawDataIndex:I,vlessVersion:A=new Uint8Array([0,0]),isUDP:y}=await K(p,U);if(d)throw new Error(h);if(y)if(f===53)i=!0;else throw new Error("UDP proxy only enable for DNS which is port 53");let u=new Uint8Array([A[0],0]),w=p.slice(I);if(i){let{write:g}=await Q(r,u);l=g,l(w);return}J(e,a,m,f,w,r,u)}})).catch(()=>{}),new Response(null,{status:101,webSocket:s})}var Ze={async fetch(e,n,t){let{pathName:s}=R(e);console.log({pathName:s});try{let r=e.headers.get("Upgrade");if(!r||r!=="websocket")switch(s){case`/sub/${U}`:return await Z(e,n);default:return n.ASSETS.fetch(e)}else return s.startsWith("/vl")?await ee(e,n):new Response(null,{status:404})}catch{return new Response("error",{status:500})}}};export{Ze as default};
