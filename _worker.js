function P(e){let t=e.headers.get("Host")||"",r=new URL(e.url),n=r.pathname;return{client:new URLSearchParams(r.search).get("app"),hostName:t,pathName:n}}var O=atob("YnBiLnlvdXNlZi5pc2VnYXJvLmNvbQ=="),Y="trojanPassword",$="https://cloudflare-dns.com/dns-query",v="2fb55e67-f61d-45a1-9619-a9cac3529382",z=["443","8443","2053","2083","2087","2096"];var M={proxyIP:"",outProxy:"",cleanIPs:"",enableIPv6:!0,customCdnAddrs:"",customCdnHost:"",customCdnSni:"",vlessConfigs:!0,trojanConfigs:!1,ports:["443"]};async function G(e){let t=`${$}?name=${encodeURIComponent(e)}&type=A`,r=`${$}?name=${encodeURIComponent(e)}&type=AAAA`;try{let[n,s]=await Promise.all([fetch(t,{headers:{accept:"application/dns-json"}}),fetch(r,{headers:{accept:"application/dns-json"}})]),o=await n.json(),c=await s.json(),a=o.Answer?o.Answer.map(l=>l.data):[],i=c.Answer?c.Answer.map(l=>l.data):[];return{ipv4:a,ipv6:i}}catch(n){throw new Error(`An error occurred while resolving DNS - ${n}`)}}function Z(e){return/^(?!-)(?:[A-Za-z0-9-]{1,63}\.)+[A-Za-z]{2,}$/.test(e)}function J(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}async function Q(e,t,r){let n=await G(e),s=r?n.ipv6.map(o=>`[${o}]`):[];return[e,"www.speedtest.net",...n.ipv4,...s,...t?t.split(","):[]]}function X(e){let t="";for(let r=0;r<e.length;r++)t+=Math.random()<.5?e[r].toUpperCase():e[r];return t}function T(e,t,r,n,s,o){let c=Z(r)?"Domain":ae(r)?"IPv4":se(r)?"IPv6":"";n.includes(r)&&(c="Clean IP");let a=o?` ${o}`:"";return`\u{1F4A6} ${e} - ${s}${a} - ${c} : ${t}`}function ae(e){return/^(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(?:\/([0-9]|[1-2][0-9]|3[0-2]))?$/.test(e)}function se(e){return/^\[(?:(?:[a-fA-F0-9]{1,4}:){7}[a-fA-F0-9]{1,4}|(?:[a-fA-F0-9]{1,4}:){1,7}:|::(?:[a-fA-F0-9]{1,4}:){0,7}|(?:[a-fA-F0-9]{1,4}:){1,6}:[a-fA-F0-9]{1,4}|(?:[a-fA-F0-9]{1,4}:){1,5}(?::[a-fA-F0-9]{1,4}){1,2}|(?:[a-fA-F0-9]{1,4}:){1,4}(?::[a-fA-F0-9]{1,4}){1,3}|(?:[a-fA-F0-9]{1,4}:){1,3}(?::[a-fA-F0-9]{1,4}){1,4}|(?:[a-fA-F0-9]{1,4}:){1,2}(?::[a-fA-F0-9]{1,4}){1,5}|[a-fA-F0-9]{1,4}:(?::[a-fA-F0-9]{1,4}){1,6})\](?:\/(1[0-1][0-9]|12[0-8]|[0-9]?[0-9]))?$/.test(e)}function q(e){let t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=r.length;for(let s=0;s<e;s++)t+=r.charAt(Math.floor(Math.random()*n));return t}async function K(e){let{hostName:t,client:r}=P(e),{cleanIPs:n,proxyIP:s,ports:o,vlessConfigs:c,trojanConfigs:a,outProxy:i,customCdnAddrs:l,customCdnHost:w,customCdnSni:p,enableIPv6:h}=M,m="",d="",b="",g=1,f=await Q(t,n,h),u=l?l.split(","):[],y=[...f,...u],R=r==="singbox"?"http/1.1":"h2,http/1.1",I=encodeURIComponent(Y),C=r==="singbox"?"&eh=Sec-WebSocket-Protocol&ed=2560":encodeURIComponent("?ed=2560");if(o.forEach(A=>{y.forEach((U,W)=>{let S=W>f.length-1,_=S?"C":"",re=S?p:X(t),j=S?w:t,B=`${q(16)}${s?`/${encodeURIComponent(btoa(s))}`:""}${C}`,ne=encodeURIComponent(T(g,A,U,n,"VLESS",_)),oe=encodeURIComponent(T(g,A,U,n,"Trojan",_)),H=z.includes(A)?`&security=tls&sni=${re}&fp=randomized&alpn=${R}`:"&security=none";c&&(m+=`${atob("dmxlc3M6Ly8=")}${v}@${U}:${A}?path=/vls${B}&encryption=none&host=${j}&type=ws${H}#${ne}
`),a&&(d+=`${atob("dHJvamFuOi8v")}${I}@${U}:${A}?path=/tr${B}&host=${j}&type=ws${H}#${oe}
`),g++})}),i){let A=`#${encodeURIComponent("\u{1F4A6} Chain proxy \u{1F517}")}`;if(i.startsWith("socks")||i.startsWith("http")){let U=/^(?:socks|http):\/\/([^@]+)@/,W=i.match(U),S=W?W[1]:!1;b=S?i.replace(S,btoa(S))+A:i+A}else b=i.split("#")[0]+A}let te=btoa(m+d+b);return new Response(te,{status:200,headers:{"Content-Type":"text/plain;charset=utf-8","Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate","CDN-Cache-Control":"no-store"}})}import{connect as ce}from"cloudflare:sockets";function x(e){try{(e.readyState===1||e.readyState===2)&&e.close()}catch{}}async function E(e,t,r,n){let s=r,o=!1;await e.readable.pipeTo(new WritableStream({start(){},close(){},abort(){},async write(c,a){o=!0,t.readyState!==1&&a.error("webSocket.readyState is not open, maybe close"),s?(t.send(await new Blob([s,c]).arrayBuffer()),s=null):t.send(c)}})).catch(()=>x(t)),!o&&n&&n()}async function L(e,t,r,n,s,o,c){let{pathName:a}=P(e);async function i(p,h){/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(p)&&(p=`${atob("d3d3Lg==")}${p}${atob("LnNzbGlwLmlv")}`);let m=ce({hostname:p,port:h});t.value=m;let d=m.writable.getWriter();return await d.write(s),d.releaseLock(),m}async function l(){let p=a.split("/")[2],h=p?atob(p).split(","):void 0,m=h?h[Math.floor(Math.random()*h.length)]:O||r,d=await i(m,n);d.closed.finally(()=>{x(o)}),E(d,o,c,null)}let w=await i(r,n);E(w,o,c,l)}async function k(e,t){let r=!1,n=new TransformStream({transform(o,c){for(let a=0;a<o.byteLength;){let i=o.slice(a,a+2),l=new DataView(i).getUint16(0),w=new Uint8Array(o.slice(a+2,a+2+l));a=a+2+l,c.enqueue(w)}}});n.readable.pipeTo(new WritableStream({async write(o){let a=await(await fetch($,{method:"POST",headers:{"content-type":"application/dns-message"},body:o})).arrayBuffer(),i=a.byteLength,l=new Uint8Array([i>>8&255,i&255]);e.readyState===1&&(r?e.send(await new Blob([l,a]).arrayBuffer()):(e.send(await new Blob([t,l,a]).arrayBuffer()),r=!0))}})).catch(()=>{});let s=n.writable.getWriter();return{write(o){s.write(o)}}}async function N(e,t){if(e.byteLength<24)return{hasError:!0,message:"invalid data"};let r=new Uint8Array(e.slice(0,1)),n=new Uint8Array(e.slice(1,17)),s=de(n),o=!1,c=t.includes(",")?t.split(","):[t],a=await le();if(o=c.some(R=>a||s===R.trim()),!o)return{hasError:!0,message:"invalid user"};let i=new Uint8Array(e.slice(17,18))[0],l=new Uint8Array(e.slice(18+i,18+i+1))[0],w=!1;if(l>1){if(l!==2)return{hasError:!0,message:`command ${l} is not support, command 01-tcp,02-udp,03-mux`};w=!0}let p=18+i+1,h=e.slice(p,p+2),m=new DataView(h).getUint16(0),d=p+2,g=new Uint8Array(e.slice(d,d+1))[0],f=0,u=d+1,y="";switch(g){case 1:f=4,y=new Uint8Array(e.slice(u,u+f)).join(".");break;case 2:f=new Uint8Array(e.slice(u,u+1))[0],u+=1,y=new TextDecoder().decode(e.slice(u,u+f));break;case 3:{f=16;let R=new DataView(e.slice(u,u+f)),I=[];for(let C=0;C<8;C++)I.push(R.getUint16(C*2).toString(16));y=I.join(":");break}default:return{hasError:!0,message:`invild  addressType is ${g}`}}return y?{hasError:!1,addressRemote:y,addressType:g,portRemote:m,rawDataIndex:u+f,vlessVersion:r,isUDP:w}:{hasError:!0,message:`addressValue is empty, addressType is ${g}`}}async function le(){return!1}function pe(e,t=0){let r=[];for(let n=0;n<256;++n)r.push((n+256).toString(16).slice(1));return(r[e[t+0]]+r[e[t+1]]+r[e[t+2]]+r[e[t+3]]+"-"+r[e[t+4]]+r[e[t+5]]+"-"+r[e[t+6]]+r[e[t+7]]+"-"+r[e[t+8]]+r[e[t+9]]+"-"+r[e[t+10]]+r[e[t+11]]+r[e[t+12]]+r[e[t+13]]+r[e[t+14]]+r[e[t+15]]).toLowerCase()}function de(e,t=0){let r=pe(e,t);if(!J(r))throw TypeError("Stringified UUID is invalid");return r}function F(e){if(!e)return{earlyData:null,error:null};try{e=e.replace(/-/g,"+").replace(/_/g,"/");let t=atob(e);return{earlyData:Uint8Array.from(t,n=>n.charCodeAt(0)).buffer,error:null}}catch(t){return{earlyData:null,error:t}}}function V(e,t){let r=!1;return new ReadableStream({start(s){e.addEventListener("message",a=>{if(r)return;let i=a.data;s.enqueue(i)}),e.addEventListener("close",()=>{x(e),!r&&s.close()}),e.addEventListener("error",a=>{s.error(a)});let{earlyData:o,error:c}=F(t);c?s.error(c):o&&s.enqueue(o)},cancel(){r||(r=!0,x(e))}})}async function ee(e){let t=new WebSocketPair,[r,n]=Object.values(t);n.accept();let s=e.headers.get("sec-websocket-protocol")||"",o=V(n,s),c={value:null},a=null,i=!1;return o.pipeTo(new WritableStream({async write(l){if(i&&a)return a(l);if(c.value){let y=c.value.writable.getWriter();await y.write(l),y.releaseLock();return}let{isUDP:w,message:p,hasError:h,rawDataIndex:m,portRemote:d=443,addressRemote:b="",vlessVersion:g=new Uint8Array([0,0])}=await N(l,v);if(h)throw new Error(p);if(w){if(d!==53)throw new Error("UDP proxy only enable for DNS which is port 53");i=!0}let f=new Uint8Array([g[0],0]),u=l.slice(m);if(i){let{write:y}=await k(n,f);a=y,a(u);return}L(e,c,b,d,u,n,f)}})),new Response(null,{status:101,webSocket:r})}var Xe={async fetch(e){let{pathName:t}=P(e);try{let r=e.headers.get("Upgrade");if(!r||r!=="websocket")switch(t){case`/configsNormal/${v}`:return await K(e);default:{let n=new URL(e.url);return n.hostname="www.speedtest.net",n.protocol="https:",e=new Request(n,e),await fetch(e)}}return t.startsWith("/vls")?await ee(e):new Response(null,{status:404})}catch{return new Response("error",{status:500})}}};export{Xe as default};
