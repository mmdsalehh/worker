var j="https://cloudflare-dns.com/dns-query",ne="142.250.191.78",U=e=>{let t=["443","8443","2053","2083","2087","2096"],n=e.headers.get("Host")||"",a="trojanPassword",c="2fb55e67-f61d-45a1-9619-a9cac3529382",r="1",s=ne,i=new URL(e.url),o=i.pathname,d=new URLSearchParams(i.search).get("app");return{defaultHttpsPorts:t,hostName:n,trojanPassword:a,userID:c,panelVersion:r,proxyIP:s,pathName:o,client:d}};var V={remoteDNS:"https://8.8.8.8/dns-query",resolvedRemoteDNS:{},localDNS:"8.8.8.8",vlessTrojanFakeDNS:!1,proxyIP:"",outProxy:"",outProxyParams:{},cleanIPs:"",enableIPv6:!0,customCdnAddrs:"",customCdnHost:"",customCdnSni:"",bestVLESSTrojanInterval:"30",vlessConfigs:!0,trojanConfigs:!1,ports:["443"],lengthMin:"100",lengthMax:"200",intervalMin:"1",intervalMax:"1",fragmentPackets:"tlshello",bypassLAN:!1,bypassIran:!1,bypassChina:!1,bypassRussia:!1,blockAds:!1,blockPorn:!1,blockUDP443:!1,customBypassRules:"",customBlockRules:"",warpEndpoints:"engage.cloudflareclient.com:2408",warpFakeDNS:!1,warpEnableIPv6:!0,warpPlusLicense:"",bestWarpInterval:"30",hiddifyNoiseMode:"m4",nikaNGNoiseMode:"quic",noiseCountMin:"10",noiseCountMax:"15",noiseSizeMin:"5",noiseSizeMax:"10",noiseDelayMin:"1",noiseDelayMax:"1",panelVersion:"1"};async function H(e){let t="https://cloudflare-dns.com/dns-query",n=`${t}?name=${encodeURIComponent(e)}&type=A`,a=`${t}?name=${encodeURIComponent(e)}&type=AAAA`;try{let[c,r]=await Promise.all([fetch(n,{headers:{accept:"application/dns-json"}}),fetch(a,{headers:{accept:"application/dns-json"}})]),s=await c.json(),i=await r.json(),o=s.Answer?s.Answer.map(d=>d.data):[],u=i.Answer?i.Answer.map(d=>d.data):[];return{ipv4:o,ipv6:u}}catch(c){throw console.error("Error resolving DNS:",c),new Error(`An error occurred while resolving DNS - ${c}`)}}function B(e){return/^(?!\-)(?:[A-Za-z0-9\-]{1,63}\.)+[A-Za-z]{2,}$/.test(e)}function O(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}async function z(e,t,n){let a=await H(e),c=n?a.ipv6.map(r=>`[${r}]`):[];return[e,"www.speedtest.net",...a.ipv4,...c,...t?t.split(","):[]]}function _(e){let t="";for(let n=0;n<e.length;n++)t+=Math.random()<.5?e[n].toUpperCase():e[n];return t}function E(e,t,n,a,c,r){let s,i=r?` ${r}`:"";return a.includes(n)?s="Clean IP":s=B(n)?"Domain":re(n)?"IPv4":se(n)?"IPv6":"",`\u{1F4A6} ${e} - ${c}${i} - ${s} : ${t}`}function re(e){return/^(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(?:\/([0-9]|[1-2][0-9]|3[0-2]))?$/.test(e)}function se(e){return/^\[(?:(?:[a-fA-F0-9]{1,4}:){7}[a-fA-F0-9]{1,4}|(?:[a-fA-F0-9]{1,4}:){1,7}:|::(?:[a-fA-F0-9]{1,4}:){0,7}|(?:[a-fA-F0-9]{1,4}:){1,6}:[a-fA-F0-9]{1,4}|(?:[a-fA-F0-9]{1,4}:){1,5}(?::[a-fA-F0-9]{1,4}){1,2}|(?:[a-fA-F0-9]{1,4}:){1,4}(?::[a-fA-F0-9]{1,4}){1,3}|(?:[a-fA-F0-9]{1,4}:){1,3}(?::[a-fA-F0-9]{1,4}){1,4}|(?:[a-fA-F0-9]{1,4}:){1,2}(?::[a-fA-F0-9]{1,4}){1,5}|[a-fA-F0-9]{1,4}:(?::[a-fA-F0-9]{1,4}){1,6})\](?:\/(1[0-1][0-9]|12[0-8]|[0-9]?[0-9]))?$/.test(e)}function q(e){let t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",a=n.length;for(let c=0;c<e;c++)t+=n.charAt(Math.floor(Math.random()*a));return t}async function G(e,t){let{hostName:n,client:a,trojanPassword:c,defaultHttpsPorts:r,userID:s}=U(e),{cleanIPs:i,proxyIP:o,ports:u,vlessConfigs:d,trojanConfigs:w,outProxy:h,customCdnAddrs:p,customCdnHost:l,customCdnSni:A,enableIPv6:y}=V,g="",f="",b="",S=1,x=await z(n,i,y),v=p?p.split(","):[],D=[...x,...v],I=a==="singbox"?"http/1.1":"h2,http/1.1",C=encodeURIComponent(c),Q=a==="singbox"?"&eh=Sec-WebSocket-Protocol&ed=2560":encodeURIComponent("?ed=2560");if(u.forEach(P=>{D.forEach((R,k)=>{let $=k>x.length-1,T=$?"C":"",X=$?A:_(n),N=$?l:n,F=`${q(16)}${o?`/${encodeURIComponent(btoa(o))}`:""}${Q}`,ee=encodeURIComponent(E(S,P,R,i,"VLESS",T)),te=encodeURIComponent(E(S,P,R,i,"Trojan",T)),M=r.includes(P)?`&security=tls&sni=${X}&fp=randomized&alpn=${I}`:"&security=none";d&&(g+=`${atob("dmxlc3M6Ly8=")}${s}@${R}:${P}?path=/${F}&encryption=none&host=${N}&type=ws${M}#${ee}
`),w&&(f+=`${atob("dHJvamFuOi8v")}${C}@${R}:${P}?path=/tr${F}&host=${N}&type=ws${M}#${te}
`),S++})}),h){let P=`#${encodeURIComponent("\u{1F4A6} Chain proxy \u{1F517}")}`;if(h.startsWith("socks")||h.startsWith("http")){let R=/^(?:socks|http):\/\/([^@]+)@/,k=h.match(R),$=k?k[1]:!1;b=$?h.replace($,btoa($))+P:h+P}else b=h.split("#")[0]+P}let K=btoa(g+f+b);return new Response(K,{status:200,headers:{"Content-Type":"text/plain;charset=utf-8","Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate","CDN-Cache-Control":"no-store"}})}import{connect as ae}from"cloudflare:sockets";var L=1,oe=2;async function Z(e,t){let{userID:n}=U(e),a=new WebSocketPair,[c,r]=Object.values(a);r.accept();let s="",i="",o=(l,A)=>{console.log(`[${s}:${i}] ${l}`,A||"")},u=e.headers.get("sec-websocket-protocol")||"",d=ie(r,u,o),w={value:null},h=null,p=!1;return d.pipeTo(new WritableStream({async write(l,A){if(p&&h)return h(l);if(w.value){let C=w.value.writable.getWriter();await C.write(l),C.releaseLock();return}let{hasError:y,message:g,portRemote:f=443,addressRemote:b="",rawDataIndex:S,vlessVersion:x=new Uint8Array([0,0]),isUDP:v}=await le(l,n);if(s=b,i=`${f}--${Math.random()} ${v?"udp ":"tcp "} `,y)throw new Error(g);if(v)if(f===53)p=!0;else throw new Error("UDP proxy only enable for DNS which is port 53");let D=new Uint8Array([x[0],0]),I=l.slice(S);if(p){let{write:C}=await pe(r,D,o);h=C,h(I);return}fe(e,w,b,f,I,r,D,o)},close(){o("readableWebSocketStream is close")},abort(l){o("readableWebSocketStream is abort",JSON.stringify(l))}})).catch(l=>{o("readableWebSocketStream pipeTo error",l)}),new Response(null,{status:101,webSocket:c})}function ie(e,t,n){let a=!1;return new ReadableStream({start(r){e.addEventListener("message",o=>{if(a)return;let u=o.data;r.enqueue(u)}),e.addEventListener("close",()=>{W(e),!a&&r.close()}),e.addEventListener("error",o=>{n("webSocketServer has error"),r.error(o)});let{earlyData:s,error:i}=ce(t);i?r.error(i):s&&r.enqueue(s)},pull(r){},cancel(r){a||(n(`ReadableStream was canceled, due to ${r}`),a=!0,W(e))}})}function W(e){try{(e.readyState===L||e.readyState===oe)&&e.close()}catch(t){console.error("safeCloseWebSocket error",t)}}function ce(e){if(!e)return{earlyData:null,error:null};try{e=e.replace(/-/g,"+").replace(/_/g,"/");let t=atob(e);return{earlyData:Uint8Array.from(t,a=>a.charCodeAt(0)).buffer,error:null}}catch(t){return{earlyData:null,error:t}}}async function le(e,t){if(e.byteLength<24)return{hasError:!0,message:"invalid data"};let n=new Uint8Array(e.slice(0,1)),a=!1,c=!1,r=new Uint8Array(e.slice(1,17)),s=ue(r),i=t.includes(",")?t.split(","):[t],o=await J(s);if(a=i.some(S=>o||s===S.trim()),console.log(`checkUuidInApi: ${await J(s)}, userID: ${s}`),!a)return{hasError:!0,message:"invalid user"};let u=new Uint8Array(e.slice(17,18))[0],d=new Uint8Array(e.slice(18+u,18+u+1))[0];if(d!==1)if(d===2)c=!0;else return{hasError:!0,message:`command ${d} is not support, command 01-tcp,02-udp,03-mux`};let w=18+u+1,h=e.slice(w,w+2),p=new DataView(h).getUint16(0),l=w+2,y=new Uint8Array(e.slice(l,l+1))[0],g=0,f=l+1,b="";switch(y){case 1:g=4,b=new Uint8Array(e.slice(f,f+g)).join(".");break;case 2:g=new Uint8Array(e.slice(f,f+1))[0],f+=1,b=new TextDecoder().decode(e.slice(f,f+g));break;case 3:g=16;let S=new DataView(e.slice(f,f+g)),x=[];for(let v=0;v<8;v++)x.push(S.getUint16(v*2).toString(16));b=x.join(":");break;default:return{hasError:!0,message:`invild  addressType is ${y}`}}return b?{hasError:!1,addressRemote:b,addressType:y,portRemote:p,rawDataIndex:f+g,vlessVersion:n,isUDP:c}:{hasError:!0,message:`addressValue is empty, addressType is ${y}`}}async function J(e){return!1}var m=[];for(let e=0;e<256;++e)m.push((e+256).toString(16).slice(1));function de(e,t=0){return(m[e[t+0]]+m[e[t+1]]+m[e[t+2]]+m[e[t+3]]+"-"+m[e[t+4]]+m[e[t+5]]+"-"+m[e[t+6]]+m[e[t+7]]+"-"+m[e[t+8]]+m[e[t+9]]+"-"+m[e[t+10]]+m[e[t+11]]+m[e[t+12]]+m[e[t+13]]+m[e[t+14]]+m[e[t+15]]).toLowerCase()}function ue(e,t=0){let n=de(e,t);if(!O(n))throw TypeError("Stringified UUID is invalid");return n}async function pe(e,t,n){let a=!1,c=new TransformStream({start(s){},transform(s,i){for(let o=0;o<s.byteLength;){let u=s.slice(o,o+2),d=new DataView(u).getUint16(0),w=new Uint8Array(s.slice(o+2,o+2+d));o=o+2+d,i.enqueue(w)}},flush(s){}});c.readable.pipeTo(new WritableStream({async write(s){let o=await(await fetch(j,{method:"POST",headers:{"content-type":"application/dns-message"},body:s})).arrayBuffer(),u=o.byteLength,d=new Uint8Array([u>>8&255,u&255]);e.readyState===L&&(n(`doh success and dns message length is ${u}`),a?e.send(await new Blob([d,o]).arrayBuffer()):(e.send(await new Blob([t,d,o]).arrayBuffer()),a=!0))}})).catch(s=>{n("dns udp has error"+s)});let r=c.writable.getWriter();return{write(s){r.write(s)}}}async function fe(e,t,n,a,c,r,s,i){let{pathName:o,proxyIP:u}=U(e);async function d(p,l){/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(p)&&(p=`${atob("d3d3Lg==")}${p}${atob("LnNzbGlwLmlv")}`);let A=ae({hostname:p,port:l});t.value=A,i(`connected to ${p}:${l}`);let y=A.writable.getWriter();return await y.write(c),y.releaseLock(),A}async function w(){let p=o.split("/")[2],l=p?atob(p).split(","):void 0,A=l?l[Math.floor(Math.random()*l.length)]:u||n,y=await d(A,a);y.closed.catch(g=>{console.log("retry tcpSocket closed error",g)}).finally(()=>{W(r)}),Y(y,r,s,null,i)}let h=await d(n,a);Y(h,r,s,w,i)}async function Y(e,t,n,a,c){let r=n,s=!1;await e.readable.pipeTo(new WritableStream({start(){},async write(i,o){s=!0,t.readyState!==L&&o.error("webSocket.readyState is not open, maybe close"),r?(t.send(await new Blob([r,i]).arrayBuffer()),r=null):t.send(i)},close(){c(`remoteConnection!.readable is close with hasIncomingData is ${s}`)},abort(i){console.error("remoteConnection!.readable abort",i)}})).catch(i=>{console.error("vlessRemoteSocketToWS has exception ",i.stack||i),W(t)}),s===!1&&a&&(c("retry"),a())}var Ie={async fetch(e,t,n){let{pathName:a,userID:c}=U(e);try{let r=e.headers.get("Upgrade");if(!r||r!=="websocket")switch(a){case`/sub/${c}`:return await G(e,t);default:return t.ASSETS.fetch(e)}else return a.startsWith("/tr")?new Response(null,{status:404}):await Z(e,t)}catch{return new Response("error",{status:500})}}};export{Ie as default};
